# Бот для формирования заказов поставщикам

Telegram-бот для быстрого формирования заказов из прайс-листов поставщиков пива и напитков.

## Возможности

- Автоматическая обработка Excel файлов (.xlsx, .xls)
- ML-классификация колонок прайс-листов
- Извлечение данных: название, пивоварня, стиль, объем, цена, остатки
- Распознавание всех типов тары: кеги (обычные и ПЭТ), бутылки, банки
- Интерактивный выбор позиций с указанием количества
- Автоматическое заполнение колонки "Заказ" в оригинальном файле
- Генерация выходного файла с сохранением всего форматирования
- Поддержка множества форматов прайс-листов разных поставщиков
- История заказов в базе данных

## Требования

- Python 3.13+
- Telegram Bot Token
- Зависимости из `requirements.txt`

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd postavki-bot
```

2. Создайте виртуальное окружение:
```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Создайте файл `.env`:
```bash
cp .env.example .env
```

5. Добавьте ваш Telegram Bot Token в `.env`:
```
TELEGRAM_BOT_TOKEN=your_token_here
```

6. Обучите ML-модель:
```bash
python -m ml.train_detector
```

## Запуск

```bash
python run_bot.py
```

Или используйте скрипт:
```bash
./start_bot.sh
```

## Структура проекта

```
postavki-bot/
├── bot/                    # Telegram бот
│   ├── handlers/          # Обработчики команд
│   ├── keyboards/         # Клавиатуры
│   └── states.py          # FSM состояния
├── core/                  # Основная логика
│   ├── parser.py         # Парсер Excel
│   ├── column_detector.py # ML-классификатор колонок
│   ├── filters.py        # Извлечение данных
│   └── order_builder.py  # Формирование отчетов
├── database/              # База данных
│   ├── models.py         # SQLAlchemy модели
│   └── crud.py           # CRUD операции
├── ml/                    # ML модели
│   ├── train_detector.py # Обучение модели
│   └── models/           # Обученные модели
├── data/                  # Данные (не в Git)
│   └── projects/         # Проекты пользователей
├── tests/                 # Тесты
└── config.py             # Конфигурация
```

## Использование

1. **Отправьте Excel файл боту** (формат `.xlsx` или `.xls`)
2. **Просмотрите список позиций** - бот автоматически распарсит файл и покажет все доступные позиции, сгруппированные по пивоварням
3. **Выберите позиции для заказа:**
   - `1 3 5` - выбрать позиции 1, 3, 5 (по 1 шт каждой)
   - `1:10 3:5` - позиция 1 (10 шт), позиция 3 (5 шт)
4. **Завершите заказ** - нажмите кнопку "Завершить заказ" или `/finish`
5. **Получите готовый файл** - бот вернет Excel файл с заполненной колонкой "Заказ"

### Формат выходного файла

Имя файла: `ДД.ММ.ГГГГ-название_поставщика.xlsx`

Примеры:
- `15.10.2025-paradox brewery.xlsx`
- `15.10.2025-beeribo.xlsx`
- `15.10.2025-cbd.xlsx`

## Фильтрация

- **Банки и бутылки**: показываются только при остатке >= 10 штук
- **Кеги**: показываются всегда, без ограничений по остаткам
- **Автоматическое удаление** служебных записей, заголовков разделов и неактуальных позиций

## Поддерживаемые форматы

### Форматы файлов
- `.xlsx` (новый формат Excel)
- `.xls` (старый формат Excel, автоматическая конвертация)

### Распознаваемые колонки

Бот автоматически распознает различные варианты названий колонок:

| Тип данных | Варианты названий колонок |
|------------|---------------------------|
| **Пивоварня** | Пивоварня, Brewery, Производитель, Наименование пивоварни |
| **Название** | Название, Наименование, Name, Продукт, Товар |
| **Стиль** | Стиль, Style, Сорт, Тип |
| **Объем** | Объем, Volume, Тип тары, Тара, Фасовка, Упаковка, Литраж |
| **Цена** | Цена, Price, Стоимость |
| **Остаток** | Остаток, Наличие, Stock, Availability |
| **Заказ** | Заказ, Order, Количество заказа, Заказ (кег/тара), шт |

### Особенности работы с колонкой "Заказ"

- Если в файле **есть** колонка "Заказ" - бот заполнит её выбранными количествами
- Если колонки "Заказ" **нет** - бот автоматически создаст её в строке заголовков
- Все заказы записываются в точные строки оригинального файла
- Сохраняется всё форматирование исходного файла

## Примеры поддерживаемых поставщиков

Бот успешно работает с прайс-листами:
- **Paradox Brewery** (203 позиции, 3 листа)
- **Beeribo** (144 позиции, 3 листа, формат .xls)
- **CBD** (480 позиций, 3 листа)
- **Zagovor** и другие

## Технические детали

### Архитектура
- **Фреймворк бота:** aiogram 3.16
- **База данных:** SQLite через SQLAlchemy (async)
- **Парсинг Excel:** pandas + openpyxl + xlrd
- **ML-классификация:** scikit-learn

### Ключевые особенности реализации

1. **Автоопределение строки заголовков:** система баллов для поиска строки с ключевыми колонками
2. **Сохранение оригинальных индексов строк:** точное соответствие между распарсенными данными и строками Excel
3. **Автоконвертация .xls → .xlsx:** для генерации выходного файла
4. **Умное определение строки заголовков при создании колонки "Заказ":** анализ структуры файла
5. **Очистка имен файлов:** удаление дат, служебных слов, нормализация

## Разработка

### Запуск тестов

```bash
pytest
```

### Переобучение ML-модели

```bash
PYTHONPATH=. python -m ml.train_detector
```

### Миграция базы данных

Если вы обновили модели базы данных, запустите миграцию:

```bash
python migrate_db.py
```

## Безопасность

Проект настроен для конфиденциальности:
- `.env` файл с токенами не попадает в Git
- База данных не попадает в Git
- Загруженные файлы пользователей не попадают в Git
- ML модели можно переобучить локально

## История изменений

### Версия 2.0 (Октябрь 2025)
- Упрощена архитектура: удалена система проектов
- Реализован режим быстрого заказа (Quick Order)
- Добавлена поддержка .xls файлов
- Улучшено определение строки заголовков
- Исправлена логика расчета номеров строк Excel
- Автоматическое создание колонки "Заказ" в правильной строке заголовков
- Улучшенная очистка имен выходных файлов
- Расширено распознавание колонок (Продукт, Тип, Наименование пивоварни)

### Версия 1.0
- Базовая функциональность парсинга Excel
- ML-классификация колонок
- Система проектов

## Известные особенности

1. **Многолистовые файлы:** обрабатываются все листы, позиции нумеруются последовательно
2. **Пустые строки:** не удаляются для сохранения правильных индексов
3. **Временные файлы:** .xls файлы конвертируются во временные .xlsx, которые автоматически удаляются
4. **Фильтрация остатков:** применяется только к банкам/бутылкам, кеги показываются всегда

## Лицензия

MIT

## Автор

Проект создан для автоматизации работы с прайс-листами поставщиков пива и напитков.
